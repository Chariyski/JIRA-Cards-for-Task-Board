<link rel="import" href="../../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="jira-fix-version-helper">
    <style>
        select {
            width: calc(50% - 9px);
        }
    </style>
    <template>
        <select id="JIRA-projects" on-change="_getVersionsForProject">
            <template is="dom-repeat" items="{{projects}}">
                <option value="{{item.key}}">{{item.name}}</option>
            </template>
        </select>

        <select id="JIRA-project-versions">
            <template is="dom-repeat" items="{{versions}}">
                <option value="{{item.id}}">{{item.name}}</option>
            </template>
        </select>

        <!-- AJAX for TODO-->
        <iron-ajax
            id="ajax-for-projects"
            content-type="application/json"
            handle-as="json"
            on-response="_updateVersionsSelectElement"
            last-response="{{projects}}"></iron-ajax>
        <!-- AJAX for TODO-->

        <!-- AJAX for TODO-->
        <iron-ajax
            id="ajax-for-versions"
            content-type="application/json"
            handle-as="json"
            last-response="{{versions}}"></iron-ajax>
        <!-- AJAX for TODO-->
    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'jira-fix-version-helper',
            properties: {
                jiraUrlAddress: {
                    type: String,
                    notify: true,
                    observer: '_jiraUrlAddressChanged'
                }
            },

            _jiraUrlAddressChanged: function (newValue, oldValue) {
                let ajaxForProjects = this.$['ajax-for-projects'];

                if (!this.jiraUrlAddress) {
                    return;
                }

                ajaxForProjects.url = this.jiraUrlAddress + '/rest/api/2/project/';
                ajaxForProjects.generateRequest();
            },

            _getVersionsForProject: function (event, jiraProjectID) {
                let ajaxForVersions = this.$['ajax-for-versions'],
                    projectID;

                if (jiraProjectID) {
                    projectID = jiraProjectID;
                } else {
                    projectID = this.$['JIRA-projects'].value;
                }

                // It is possible that the function is call without an option to take a valid projet ID
                if (!projectID) {
                    return;
                }

                ajaxForVersions.url = this.jiraUrlAddress + '/rest/api/2/project/' + projectID + '/versions';
                ajaxForVersions.generateRequest();
            },

            _updateVersionsSelectElement: function (event, ironRequest) {
                this._getVersionsForProject(null, ironRequest.response[0].id);
            }
        });
    })();
</script>
<!--TODO create behavior element for both jira helpers-->
